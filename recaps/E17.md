# E17

## API

[Pourquoi une API ?](https://whimsical.com/why-api-3zTnLPn1W1nVN3h8fiRBtg)

[Jusqu'o√π on peut aller avec des API ? (conceptuel)](https://whimsical.com/exo-c-domotique-architecture-Kq4NdqZrdafgyGw5swcEjJ)

## A nous de jouer

une API c'est une route qui renvoie du JSON.

Une route c'est une m√©thode dans un controlleur.
Cette m√©thode renvoie du JSON, pas de twig, donc pas de template.

```bash
bin/console make:controller --no-template

 Choose a name for your controller class (e.g. OrangePopsicleController):
 > Api\Person

 created: src/Controller/Api/PersonController.php

           
  Success! 
           

 Next: Open your new controller class and add some pages!
```

On voit de suite que le controlleur n'utilise pas `$this->render()` mais un `$this->json()`

Magnifique, tentons de lui donner la liste des person de la BDD.

Malheureusement, cette m√©thode `$this->json()` n'a pas l'intelligence de twig, et ne sait lire que les propri√©t√©s publique.

On va donc utiliser un composant pour, par annotation, lui donner cette intelligence.

[doc](https://symfony.com/doc/5.4/components/serializer.html)

```bash
composer require symfony/serializer
```

üéâ √ßa marche avec des propri√©t√©s priv√©es !

## erreur circular reference

```text
A circular reference has been detected when serializing the object of class "App\Entity\Movie" (configured limit: 1).
```

on lui demande de serialiser Movie->Seasons->Movie->Seasons->Movie ....

Pour r√©soudre √ßa on utilise les groupes de serialisation

### Groupes de s√©rialisation

[doc](https://symfony.com/doc/5.4/components/serializer.html#attributes-groups)

```php
use Symfony\Component\Serializer\Annotation\Groups;
/**
 * @Groups("api_show_movie")
 * @Groups({"autre_groupe_1", "autre_groupe_2"})
 */
public $maPropriete;
```

```text
[Semantical Error] Annotation @Groups is not allowed to be declared on class App\Entity\Movie. You may only use this annotation on these code elements: PROPERTY, METHOD.
```

et dans le controller

```php
return $this->json(
    // data
    $allMovie,
    // code HTTP pour dire que tout se passe bien (200) 
    Response::HTTP_OK,
    [],
    [
        // je lui donne le/les noms de groupes de serialisation
        "groups" => 
        [
            "api_show_movie"
        ]
    ]
);
```

‚ö†Ô∏è le nommage des groupes √©tant libre, il est FORTEMENT conseill√© de mettre des noms explicites
voir de faire une documentation pr√©cise

| nom_groupe | controller/method | entity/property |
|--|--|--|
|api_show_movie|/api/movie|Movie::releaseDate, Movie::Seasons, Season::name|

L'utilisation des groupes nous permet de sp√©cifier ce que l'on veut serialiser m√™me sur les relations et donc sur des propri√©t√©s 'inter-entity'

‚ö†Ô∏è Attention √† ne pas mettre les deux sens d'une m√™me relation dans le m√™me groupe, sinon la r√©f√©rence circulaire va revenir.

### PB du paramconverter

Si on utilise le paramConverter, et qu'il n'arrive pas √† trouver l'objet demand√©, il va nous g√©n√©rer une page HTML d'erreur.

Et √ßa on n'en veut pas en mode API.

on doit donc nous autoriser la valeur NULL dans notre m√©thode, et donc g√©rer le fait que l'on nous donne la valeur NULL "√† la main"

```php
public function read(Movie $movie = null)
{
    if ($movie === null)
    {
        // on renvoie donc une 404
        return $this->json(
            [
                "erreur" => "le film n'a pas √©t√© trouv√©",
                "code_error" => 404
            ],
            Response::HTTP_NOT_FOUND,// 404
            // les autres param√®tres sont inutiles
        );
    }

    // code quand on a trouv√© le film
}
```

## Event correction

### Doctrine

objectif est de dire √† doctrine de s'occuper de mettre √† jour le slug √† deux moments :

1. avant la cr√©ation (prePersist)
2. avant la mise √† jour (preUpdate)

#### demo simple avec updateAt : mise √† jour avant chaque update

```bash
bin/console make:ent Movie

 Your entity already exists! So let's add some new fields!

 New property name (press <return> to stop adding fields):
 > updatedAt

 Field type (enter ? to see all types) [datetime_immutable]:
 > datetime

 Can this field be null in the database (nullable) (yes/no) [no]:
 > y

 updated: src/Entity/Movie.php

 Add another property? Enter the property name (or press <return> to stop adding fields):
 > 


           
  Success! 
           
```

```bash
bin/console ma:mi
bin/console d:m:m
```

j'active les event avec l'annotation

```php
/*
 * @ORM\HasLifecycleCallbacks()
 */
class Movie
{
    /**
     * @ORM\PreUpdate
     */
    public function setUpdateAtValue(): void
    {
        $this->updatedAt = new DateTime('now');
    }
}
```

#### preUpdate avec un listener

on cr√©e une classe simple, que l'on param√®tre dans le fichier services.yaml

[doc](https://symfony.com/doc/5.4/doctrine/events.html#doctrine-entity-listeners)

```yaml
    App\EventListener\MovieListener:
        tags:
            -
                name: 'doctrine.orm.entity_listener'
                event: 'preUpdate'
                entity: 'App\Entity\Movie'
```

#### prePersist avec un listener

m·∫øme classe, potentiellement m√™me m√©thode, juste du param√©trage

```yaml
name: 'doctrine.orm.entity_listener'
event: 'prePersist'
entity: 'App\Entity\Movie'
method: 'generationSlug'
```
